name: Publish

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      registry:
        description: 'Registry to publish to'
        required: true
        type: choice
        options:
          - all
          - cargo
          - npm
          - homebrew

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Publish to crates.io
  publish-cargo:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.registry == 'cargo' || github.event.inputs.registry == 'all'))

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          rustflags: ""

      - name: Check package
        run: cargo package --no-verify

      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CRATES_IO_TOKEN }}
        continue-on-error: true

  # Publish to GitHub Packages (NPM)
  publish-npm-github:
    name: Publish to GitHub NPM
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.registry == 'npm' || github.event.inputs.registry == 'all'))
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@ringo380'

      - name: Check if desktop-app exists
        id: check_app
        run: |
          if [ -f "desktop-app/package.json" ]; then
            echo "ready=true" >> $GITHUB_OUTPUT
          else
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "Desktop app package.json not found, skipping npm publish"
          fi

      - name: Update version
        if: steps.check_app.outputs.ready == 'true'
        run: |
          VERSION=${{ github.ref_name }}
          VERSION=${VERSION#v}
          cd desktop-app
          npm version $VERSION --no-git-tag-version --allow-same-version

      - name: Publish to GitHub Packages
        if: steps.check_app.outputs.ready == 'true'
        working-directory: desktop-app
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Publish to public NPM registry
  publish-npm-registry:
    name: Publish to NPM Registry
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'release' && github.event.release.prerelease == false) ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.registry == 'npm' || github.event.inputs.registry == 'all'))

    steps:
      - uses: actions/checkout@v4

      - name: Check if desktop-app exists
        id: check_app
        run: |
          if [ -f "desktop-app/package.json" ]; then
            echo "ready=true" >> $GITHUB_OUTPUT
          else
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "Desktop app package.json not found, skipping npm publish"
          fi

      - name: Setup Node.js
        if: steps.check_app.outputs.ready == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Update version
        if: steps.check_app.outputs.ready == 'true'
        run: |
          VERSION=${{ github.ref_name }}
          VERSION=${VERSION#v}
          cd desktop-app
          npm version $VERSION --no-git-tag-version --allow-same-version

      - name: Publish to NPM Registry
        if: steps.check_app.outputs.ready == 'true'
        working-directory: desktop-app
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Update Homebrew formula
  update-homebrew:
    name: Update Homebrew Formula
    runs-on: macos-latest
    if: |
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.registry == 'homebrew' || github.event.inputs.registry == 'all'))
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get release info
        id: release
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION=$(gh release view --json tagName -q .tagName)
          fi
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Calculate SHA256 checksums
        id: checksums
        run: |
          VERSION=${{ steps.release.outputs.version }}

          # Download binaries
          curl -L -o inferno-macos-arm64 \
            "https://github.com/ringo380/inferno/releases/download/v${VERSION}/inferno-macos-arm64"
          curl -L -o inferno-macos-x86_64 \
            "https://github.com/ringo380/inferno/releases/download/v${VERSION}/inferno-macos-x86_64"

          # Calculate checksums
          ARM64_SHA=$(shasum -a 256 inferno-macos-arm64 | awk '{print $1}')
          X86_64_SHA=$(shasum -a 256 inferno-macos-x86_64 | awk '{print $1}')

          echo "arm64_sha=${ARM64_SHA}" >> $GITHUB_OUTPUT
          echo "x86_64_sha=${X86_64_SHA}" >> $GITHUB_OUTPUT

      - name: Update Homebrew formula
        run: |
          VERSION=${{ steps.release.outputs.version }}
          ARM64_SHA=${{ steps.checksums.outputs.arm64_sha }}
          X86_64_SHA=${{ steps.checksums.outputs.x86_64_sha }}

          # Update version and checksums in formula
          sed -i '' "s/version \".*\"/version \"${VERSION}\"/" homebrew/inferno.rb
          sed -i '' "s/ARM64_SHA256_PLACEHOLDER/${ARM64_SHA}/" homebrew/inferno.rb
          sed -i '' "s/X86_64_SHA256_PLACEHOLDER/${X86_64_SHA}/" homebrew/inferno.rb

      - name: Create Homebrew tap repository update
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

          # Fetch latest changes and checkout main branch
          git fetch origin
          git checkout main || git checkout -b main

          git add homebrew/inferno.rb
          git commit -m "chore: update Homebrew formula for v${{ steps.release.outputs.version }}" || echo "No changes to commit"

          # Push to main branch
          git push origin HEAD:main || echo "No changes to push"
